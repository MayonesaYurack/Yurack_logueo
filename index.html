<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Código de Taladro</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --background-color: #ecf0f1;
            --text-color: #333;
            --white: #ffffff;
            --soft-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Times New Roman', Times, serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 1.5rem;
            background-color: var(--white);
            min-height: 100vh;
            box-shadow: var(--soft-shadow);
            position: relative;  
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 2rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .add-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2.5rem;  
            color: var(--primary-color);  
            line-height: 1;
            padding: 0;
            z-index: 10;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .add-btn:hover {
            color: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .form-group input, 
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, 
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: var(--secondary-color);
        }

        /* Forma de Mineralizacion Styles */
        .forma-min-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align to the left */
        }

        .forma-min-group .checkbox-label {
            width: 100%;
            text-align: left;
            margin-bottom: 0.5rem;
        }

        .forma-min-group .checkbox-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start; /* Align to the left */
            gap: 0.5rem;
            width: 100%;
        }

        .forma-min-group .checkbox-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #f4f4f4;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            margin-right: 0.5rem;
        }

        .forma-min-group .checkbox-options label:hover {
            background-color: #e7e7e7;
        }

        .forma-min-group .checkbox-options label:has(input:checked) {
            background-color: var(--primary-color);
            color: white;
        }

        .forma-min-group .checkbox-options label input {
            margin-right: 0.5rem;
        }

        .btn-submit {
            margin-top: 2rem;
        }

        /* Resto de estilos anteriores... */
        .list-item {
            background-color: #f9f9f9;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--soft-shadow);
        }

        .export-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .export-dialog-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: var(--soft-shadow);
        }

        .codes-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .codes-selection label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #f4f4f4;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .codes-selection label:hover {
            background-color: #e7e7e7;
        }

        .dialog-actions {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }

        .dialog-actions .btn {
            flex: 1;
        }

        /* Updated checkbox group styles for better multi-select appearance */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .checkbox-group label {
            width: 100%;
            text-align: center;
        }

        .checkbox-options {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            width: 100%;
        }

        .checkbox-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            background-color: #f4f4f4;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            flex-grow: 0;
        }

        .checkbox-options label:hover {
            background-color: #e7e7e7;
        }

        .checkbox-options label:has(input:checked) {
            background-color: var(--primary-color);
            color: white;
        }

        .checkbox-options label input {
            margin-right: 0.5rem;
        }

        /* Updated styles for Tamaño de Grano group */
        .tamano-grano-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .tamano-grano-group .checkbox-label {
            width: 100%;
            text-align: left;
            margin-bottom: 0.5rem;
        }

        .tamano-grano-group .checkbox-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 0.5rem;
            width: 100%;
        }

        .tamano-grano-group .checkbox-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #f4f4f4;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            margin-right: 0.5rem;
            text-align: left;
        }

        .tamano-grano-group .checkbox-options label:hover {
            background-color: #e7e7e7;
        }

        .tamano-grano-group .checkbox-options label:has(input:checked) {
            background-color: var(--primary-color);
            color: white;
        }

        .tamano-grano-group .checkbox-options label input {
            margin-right: 0.5rem;
        }
        
        .tramo-image {
            max-width: 100%;  
            max-height: 300px;  
            width: auto;  
            height: auto;  
            object-fit: contain;  
            display: block;  
            margin: 0 auto;  
            border-radius: 6px;  
        }

        .image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 100%;  
            width: 100%;  
            overflow: hidden;  
            margin-top: 1rem;
            border: 1px solid #e0e0e0;  
            border-radius: 6px;  
            padding: 0.5rem;  
            box-sizing: border-box;  
        }

        .image-description {
            margin-top: 0.5rem;
            font-style: italic;
            color: #666;
            text-align: center;
            word-wrap: break-word;  
            max-width: 100%;
            padding: 0 0.5rem;  
        }
    </style>
    <script src="cordova.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="FileManager.js"></script>
</head>
<body>
    <div id="app">
        <!-- Páginas se cargarán dinámicamente aquí -->
    </div>

    <script>
        localforage.config({
            driver: [
                localforage.INDEXEDDB,
                localforage.WEBSQL,
                localforage.LOCALSTORAGE
            ],
            name: 'TaladroAppStorage',
            version: 1.0,
            size: 5 * 1024 * 1024 * 1024 // 5GB
        });

        class TaladroApp {
            constructor() {
                this.initializeStorage()
                    .then(() => {
                        this.app = document.getElementById('app');
                        this.renderMainPage();
                    })
                    .catch(error => {
                        console.error('Storage initialization failed:', error);
                        alert('No se pudo inicializar el almacenamiento. Algunas funciones pueden estar limitadas.');
                        this.app = document.getElementById('app');
                        this.codes = [];
                        this.tramos = {};
                        this.renderMainPage();
                    });
            }

            async initializeStorage() {
                try {
                    if (window.cordova && window.cordova.file) {
                        this.storageMethod = 'cordova';
                        await this.initializeCordovaStorage();
                    } else {
                        this.storageMethod = 'localforage';
                    }

                    this.codes = await this.getData('taladroCodeList') || [];
                    this.tramos = await this.getData('taladroTramos') || {};
                } catch (error) {
                    console.error('Storage migration error:', error);
                    this.codes = [];
                    this.tramos = {};
                }
            }

            async initializeCordovaStorage() {
                return new Promise((resolve, reject) => {
                    window.requestFileSystem(
                        LocalFileSystem.PERSISTENT, 
                        5 * 1024 * 1024 * 1024, // 5GB
                        (fileSystem) => {
                            this.fileSystem = fileSystem;
                            resolve();
                        },
                        (error) => {
                            console.error('File system error:', error);
                            reject(error);
                        }
                    );
                });
            }

            async getData(key) {
                if (this.storageMethod === 'cordova') {
                    return this.getCordovaData(key);
                } else {
                    return await localforage.getItem(key);
                }
            }

            async setData(key, value) {
                if (this.storageMethod === 'cordova') {
                    return this.setCordovaData(key, value);
                } else {
                    return await localforage.setItem(key, value);
                }
            }

            async getCordovaData(key) {
                return new Promise((resolve, reject) => {
                    const fileName = `${key}.json`;
                    this.fileSystem.root.getFile(fileName, { create: false }, 
                        (fileEntry) => {
                            fileEntry.file((file) => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    try {
                                        const data = JSON.parse(reader.result);
                                        resolve(data);
                                    } catch (error) {
                                        console.error('Error parsing JSON:', error);
                                        resolve(null);
                                    }
                                };
                                reader.readAsText(file);
                            }, 
                            (error) => {
                                console.error('File read error:', error);
                                resolve(null);
                            });
                        },
                        (error) => {
                            if (error.code === 1) {
                                resolve(null);
                            } else {
                                console.error('Get file error:', error);
                                resolve(null);
                            }
                        }
                    );
                });
            }

            async setCordovaData(key, value) {
                return new Promise((resolve, reject) => {
                    const fileName = `${key}.json`;
                    this.fileSystem.root.getFile(fileName, { create: true }, 
                        (fileEntry) => {
                            fileEntry.createWriter((fileWriter) => {
                                fileWriter.onwriteend = () => {
                                    resolve();
                                };
                                fileWriter.onerror = (error) => {
                                    console.error('Write error:', error);
                                    reject(error);
                                };

                                const dataBlob = new Blob(
                                    [JSON.stringify(value)], 
                                    { type: 'application/json' }
                                );
                                fileWriter.write(dataBlob);
                            });
                        },
                        (error) => {
                            console.error('File creation error:', error);
                            reject(error);
                        }
                    );
                });
            }

            async saveCodesLocalStorage() {
                try {
                    await this.setData('taladroCodeList', this.codes);
                } catch (error) {
                    console.error('Error saving codes:', error);
                    alert('No se pudieron guardar los códigos.');
                }
            }

            async saveTramoLocalStorage() {
                try {
                    await this.setData('taladroTramos', this.tramos);
                } catch (error) {
                    console.error('Error saving tramos:', error);
                    alert('No se pudieron guardar los tramos.');
                }
            }

            renderMainPage() {
                this.app.innerHTML = `
                    <div class="container">
                        <h1>Código de Taladro</h1>
                        <form id="add-code-form">
                            <div class="form-group">
                                <label>Ingrese nuevo código:</label>
                                <input type="text" id="code-input" placeholder="Ingresar nuevo código" required>
                            </div>
                            <button type="submit" class="btn">Agregar Código</button>
                        </form>
                        <ul id="code-list">
                            ${this.codes.map((code, index) => `
                                <li class="list-item" data-code="${code}">
                                    ${code}
                                    <div>
                                        <button class="btn btn-delete" data-index="${index}">Borrar</button>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                        <button class="btn export-btn">Exportar a Excel</button>
                    </div>
                `;

                const form = this.app.querySelector('#add-code-form');
                const codeInput = this.app.querySelector('#code-input');
                const codeList = this.app.querySelector('#code-list');
                const exportBtn = this.app.querySelector('.export-btn');

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newCode = codeInput.value.trim();
                    if (newCode && !this.codes.includes(newCode)) {
                        this.codes.push(newCode);
                        this.saveCodesLocalStorage();
                        this.renderMainPage();
                        codeInput.value = '';
                    }
                });

                codeList.addEventListener('click', (e) => {
                    const codeElement = e.target.closest('.list-item');
                    const deleteBtn = e.target.closest('.btn-delete');

                    if (deleteBtn) {
                        const index = deleteBtn.dataset.index;
                        this.codes.splice(index, 1);
                        this.saveCodesLocalStorage();
                        this.renderMainPage();
                    } else if (codeElement) {
                        const code = codeElement.dataset.code;
                        this.renderTramoPage(code);
                    }
                });

                exportBtn.addEventListener('click', () => this.showExportDialog());
            }

            renderTramoPage(code) {
                const tramos = this.tramos[code] || [];
                
                this.app.innerHTML = `
                    <div class="container">
                        <button class="back-btn" id="back-btn">←</button>
                        <button class="add-btn" id="add-tramo-btn">+</button>
                        <h1>Tramos de ${code}</h1>

                        <div id="tramos-list">
                            ${tramos.map((tramo, index) => `
                                <div class="tramo-details">
                                    <p>Profundidad: ${tramo.profundidadInicio} - ${tramo.profundidadFinal}</p>
                                    <p>Tipo de Roca: ${tramo.tipoRoca}</p>
                                    ${tramo.image ? `
                                        <div class="image-container">
                                            <img src="${tramo.image}" class="tramo-image" alt="Imagen del Tramo">
                                            ${tramo.imageDescription ? `
                                                <p class="image-description">${tramo.imageDescription}</p>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    <div>
                                        <button class="btn btn-view" data-index="${index}">Ver</button>
                                        <button class="btn btn-edit" data-index="${index}">Editar</button>
                                        <button class="btn btn-delete" data-index="${index}">Borrar</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                const backBtn = this.app.querySelector('#back-btn');
                const addTramoBtn = this.app.querySelector('#add-tramo-btn');
                const tramosList = this.app.querySelector('#tramos-list');

                backBtn.addEventListener('click', () => this.renderMainPage());
                addTramoBtn.addEventListener('click', () => this.renderTramoForm(code));

                tramosList.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.btn-delete');
                    const editBtn = e.target.closest('.btn-edit');
                    const viewBtn = e.target.closest('.btn-view');
                    
                    if (deleteBtn) {
                        const index = deleteBtn.dataset.index;
                        this.tramos[code].splice(index, 1);
                        this.saveTramoLocalStorage();
                        this.renderTramoPage(code);
                    } else if (editBtn) {
                        const index = editBtn.dataset.index;
                        this.renderTramoForm(code, tramos[index], index);
                    } else if (viewBtn) {
                        const index = viewBtn.dataset.index;
                        this.renderTramoDetails(code, tramos[index]);
                    }
                });
            }

            renderTramoDetails(code, tramo) {
                this.app.innerHTML = `
                    <div class="container">
                        <button class="back-btn" id="back-btn">←</button>
                        <h1>Detalles del Tramo de ${code}</h1>

                        <div class="tramo-details-view">
                            <div class="detail-group">
                                <strong>Profundidad Inicio:</strong> 
                                <span>${parseFloat(tramo.profundidadInicio).toFixed(5)} m</span>
                            </div>
                            <div class="detail-group">
                                <strong>Profundidad Final:</strong> 
                                <span>${parseFloat(tramo.profundidadFinal).toFixed(5)} m</span>
                            </div>
                            <div class="detail-group">
                                <strong>Tipo de Roca:</strong> 
                                <span>${tramo.tipoRoca}</span>
                            </div>
                            ${tramo.tamanoGrano && tramo.tipoRoca === 'Brecha' ? `
                                <div class="detail-group">
                                    <strong>Tamaño de Grano:</strong> 
                                    <span>${tramo.tamanoGrano}</span>
                                </div>
                            ` : ''}
                            <div class="detail-group">
                                <strong>Contacto Superior:</strong> 
                                <span>${tramo.contactoSuperior}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Contacto Inferior:</strong> 
                                <span>${tramo.contactoInferior}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Zr-TiO2:</strong> 
                                <span>${tramo.zrTiO2 ? parseFloat(tramo.zrTiO2).toFixed(5) : 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <strong>AI:</strong> 
                                <span>${tramo.ai ? parseFloat(tramo.ai).toFixed(5) : 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <strong>CPPI:</strong> 
                                <span>${tramo.cppi ? parseFloat(tramo.cppi).toFixed(5) : 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Moteado:</strong> 
                                <span>${tramo.moteado || 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Magnetismo:</strong> 
                                <span>${tramo.magnetismo}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Tipo de Alteración:</strong> 
                                <span>${tramo.tipoAlteracion || 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Porcentaje de Pirita:</strong> 
                                <span>${tramo.porcentajePirita ? parseFloat(tramo.porcentajePirita).toFixed(5) : 'N/A'}%</span>
                            </div>
                            <div class="detail-group">
                                <strong>Forma de Mineralización:</strong> 
                                <span>${tramo.formaMin}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Mineralización:</strong> 
                                <span>${tramo.mineralizacion || 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <strong>Descripción:</strong> 
                                <span>${tramo.descripcion || 'N/A'}</span>
                            </div>

                            ${tramo.image ? `
                                <div class="detail-group image-section">
                                    <strong>Imagen:</strong>
                                    <div class="image-container">
                                        <img src="${tramo.image}" class="tramo-image" alt="Imagen del Tramo">
                                        ${tramo.imageDescription ? `
                                            <p class="image-description">${tramo.imageDescription}</p>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                const backBtn = this.app.querySelector('#back-btn');
                backBtn.addEventListener('click', () => this.renderTramoPage(code));
            }

            renderTramoForm(code, tramo = null, index = null) {
                const tramos = this.tramos[code] || [];
                const lastTramo = tramos.length > 0 ? tramos[tramos.length - 1].profundidadFinal : 0;
                
                this.app.innerHTML = `
                    <div class="container">
                        <button class="back-btn" id="back-btn">←</button>
                        <h1>${tramo ? 'Editar' : 'Agregar'} Tramo para ${code}</h1>
                        <form id="tramo-form">
                            <div class="form-group">
                                <label>Profundidad Inicio *</label>
                                <input type="number" id="profundidad-inicio" step="0.00001" min="0" 
                                       value="${tramo ? tramo.profundidadInicio : lastTramo}" 
                                       required>
                            </div>
                            <div class="form-group">
                                <label>Profundidad Final *</label>
                                <input type="number" id="profundidad-final" step="0.00001" min="0" 
                                       value="${tramo ? tramo.profundidadFinal : ''}" 
                                       required>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Roca *</label>
                                <select id="tipo-roca" required>
                                    <option value="">Seleccionar</option>
                                    <option value="Otro" 
                                            ${tramo && tramo.tipoRoca === 'Otro' ? 'selected' : ''}>
                                        Otro
                                    </option>
                                    <option value="Basalto/Andesita" 
                                            ${tramo && tramo.tipoRoca === 'Basalto/Andesita' ? 'selected' : ''}>
                                        Basalto/Andesita
                                    </option>
                                    <option value="Andesita" 
                                            ${tramo && tramo.tipoRoca === 'Andesita' ? 'selected' : ''}>
                                        Andesita
                                    </option>
                                    <option value="Dacita/Riodacita" 
                                            ${tramo && tramo.tipoRoca === 'Dacita/Riodacita' ? 'selected' : ''}>
                                        Dacita/Riodacita
                                    </option>
                                    <option value="Riodacita/Dacita" 
                                            ${tramo && tramo.tipoRoca === 'Riodacita/Dacita' ? 'selected' : ''}>
                                        Riodacita/Dacita
                                    </option>
                                    <option value="Riolita" 
                                            ${tramo && tramo.tipoRoca === 'Riolita' ? 'selected' : ''}>
                                        Riolita
                                    </option>
                                    <option value="Dique" 
                                            ${tramo && tramo.tipoRoca === 'Dique' ? 'selected' : ''}>
                                        Dique
                                    </option>
                                    <option value="Brecha" 
                                            ${tramo && tramo.tipoRoca === 'Brecha' ? 'selected' : ''}>
                                        Brecha
                                    </option>
                                </select>
                            </div>
                            <div class="form-group tamano-grano-group" id="tamano-grano-group" 
                                 style="display:${tramo && tramo.tipoRoca === 'Brecha' ? 'block' : 'none'};">
                                <div class="checkbox-label">
                                    <label>Tamaño de Grano:</label>
                                </div>
                                <div class="checkbox-options">
                                    ${['Muy Fino (<2mm)', 'Fino (2-4mm)', 'Medio (4-20mm)', 
                                       'Grueso (2-6cm)', 'Muy Grueso (>6cm)']
                                       .map(size => `
                                       <label>
                                         <input type="checkbox" name="tamano-grano" value="${size}"
                                                ${tramo && tramo.tamanoGrano && 
                                                 tramo.tamanoGrano.includes(size) ? 'checked' : ''}>
                                         ${size}
                                       </label>
                                   `).join('')}
                                </div>
                            </div>
                            
                            <div class="form-group forma-min-group" id="forma-min-group">
                                <div class="checkbox-label">
                                    <label>Forma de Mineralización:</label>
                                </div>
                                <div class="checkbox-options">
                                    ${['Vetas', 'Venillas', 'Diseminado', 'Parches', 'Masivo']
                                        .map(forma => `
                                        <label>
                                            <input type="checkbox" name="forma-min" value="${forma}"
                                                ${tramo && (tramo.formaMin || '').split(', ').includes(forma) ? 'checked' : ''}>
                                            ${forma}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Contacto Superior</label>
                                <input type="text" id="contacto-superior" 
                                       value="${tramo ? tramo.contactoSuperior || '' : ''}" 
                                       placeholder="Ej. 45° o Irregular">
                            </div>
                            <div class="form-group">
                                <label>Contacto Inferior:</label>
                                <input type="text" id="contacto-inferior" value="${tramo ? tramo.contactoInferior : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Zr-TiO2:</label>
                                <input type="number" id="zr-tio2" step="0.00001" 
                                       value="${tramo ? tramo.zrTiO2 : ''}">
                            </div>
                            <div class="form-group">
                                <label>AI:</label>
                                <input type="number" id="ai" step="0.00001" 
                                       value="${tramo ? tramo.ai : ''}">
                            </div>
                            <div class="form-group">
                                <label>CPPI:</label>
                                <input type="number" id="cppi" step="0.00001" 
                                       value="${tramo ? tramo.cppi : ''}">
                            </div>
                            <div class="form-group">
                                <label>Moteado:</label>
                                <select id="moteado">
                                    <option value="n/a" ${!tramo || !tramo.moteado || tramo.moteado === 'n/a' ? 'selected' : ''}>N/A</option>
                                    <option value="claro" ${tramo && tramo.moteado === 'claro' ? 'selected' : ''}>Claro</option>
                                    <option value="oscuro" ${tramo && tramo.moteado === 'oscuro' ? 'selected' : ''}>Oscuro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Magnetismo:</label>
                                <input type="text" id="magnetismo" value="${tramo ? tramo.magnetismo : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Alteración:</label>
                                <input type="text" id="tipo-alteracion" value="${tramo ? tramo.tipoAlteracion : ''}">
                            </div>
                            <div class="form-group">
                                <label>Porcentaje de Pirita:</label>
                                <input type="number" id="porcentaje-pirita" 
                                       step="0.00001" min="0" max="100" 
                                       value="${tramo ? tramo.porcentajePirita : ''}">
                            </div>
                            <div class="form-group">
                                <label>Mineralización:</label>
                                <input type="text" id="mineralizacion" value="${tramo ? tramo.mineralizacion : ''}">
                            </div>
                            <div class="form-group">
                                <label>Descripción:</label>
                                <textarea id="descripcion">${tramo ? tramo.descripcion || '' : ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Imagen:</label>
                                <input type="file" id="image" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label>Descripción de Imagen:</label>
                                <textarea id="image-description">${tramo ? tramo.imageDescription : ''}</textarea>
                            </div>
                            <button type="submit" class="btn btn-submit">
                                ${tramo ? 'Actualizar' : 'Agregar'} Tramo
                            </button>
                        </form>
                    </div>
                `;

                const backBtn = this.app.querySelector('#back-btn');
                const form = this.app.querySelector('#tramo-form');
                const tipoRocaSelect = this.app.querySelector('#tipo-roca');
                const tamanoGranoGroup = this.app.querySelector('#tamano-grano-group');

                tipoRocaSelect.addEventListener('change', (e) => {
                    tamanoGranoGroup.style.display = e.target.value === 'Brecha' ? 'block' : 'none';
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const profundidadInicio = parseFloat(document.getElementById('profundidad-inicio').value).toFixed(5);
                    const profundidadFinal = parseFloat(document.getElementById('profundidad-final').value).toFixed(5);
                    const tipoRoca = document.getElementById('tipo-roca').value;

                    if (!profundidadInicio || !profundidadFinal || !tipoRoca) {
                        alert('Profundidad Inicio, Profundidad Final y Tipo de Roca son campos obligatorios');
                        return;
                    }

                    const tamanoGranoCheckboxes = document.querySelectorAll('input[name="tamano-grano"]:checked');
                    const tamanoGrano = Array.from(tamanoGranoCheckboxes)
                        .map(cb => cb.value)
                        .join(', ');

                    const formaMinCheckboxes = document.querySelectorAll('input[name="forma-min"]:checked');
                    const formaMin = Array.from(formaMinCheckboxes)
                        .map(cb => cb.value)
                        .join(', ');

                    const selectedFormaMin = formaMin;

                    const newTramo = {
                        profundidadInicio,
                        profundidadFinal,
                        tipoRoca,
                        tamanoGrano: tipoRoca === 'Brecha' ? tamanoGrano : '', 
                        formaMin: selectedFormaMin,
                        contactoSuperior: document.getElementById('contacto-superior').value || '',
                        contactoInferior: document.getElementById('contacto-inferior').value || '',  
                        zrTiO2: document.getElementById('zr-tio2').value ? 
                            parseFloat(document.getElementById('zr-tio2').value).toFixed(5) : '',
                        ai: document.getElementById('ai').value ? 
                            parseFloat(document.getElementById('ai').value).toFixed(5) : '',
                        cppi: document.getElementById('cppi').value ? 
                            parseFloat(document.getElementById('cppi').value).toFixed(5) : '',
                        moteado: document.getElementById('moteado').value || '',
                        magnetismo: document.getElementById('magnetismo').value || '',  
                        tipoAlteracion: document.getElementById('tipo-alteracion').value || '',
                        porcentajePirita: document.getElementById('porcentaje-pirita').value ? 
                            parseFloat(document.getElementById('porcentaje-pirita').value).toFixed(5) : '',
                        mineralizacion: document.getElementById('mineralizacion').value || '',
                        descripcion: document.getElementById('descripcion').value || '',
                        imageDescription: document.getElementById('image-description').value
                    };

                    const imageFile = document.getElementById('image').files[0];
                    let imageDataUrl;
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            imageDataUrl = event.target.result;
                            newTramo.image = imageDataUrl;
                            const saveTramo = (tramo) => {
                                if (!this.tramos[code]) {
                                    this.tramos[code] = [];
                                }

                                if (tramo) {
                                    if (index !== null) {
                                        this.tramos[code][index] = tramo;
                                    } else {
                                        this.tramos[code].push(tramo);
                                    }

                                    this.saveTramoLocalStorage();
                                    this.renderTramoPage(code);
                                }
                            };
                            saveTramo(newTramo);
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        const saveTramo = (tramo) => {
                            if (!this.tramos[code]) {
                                this.tramos[code] = [];
                            }

                            if (tramo) {
                                if (index !== null) {
                                    this.tramos[code][index] = tramo;
                                } else {
                                    this.tramos[code].push(tramo);
                                }

                                this.saveTramoLocalStorage();
                                this.renderTramoPage(code);
                            }
                        };
                        saveTramo(newTramo);
                    }
                });

                backBtn.addEventListener('click', () => this.renderTramoPage(code));
            }

            showExportDialog() {
                const dialog = document.createElement('div');
                dialog.classList.add('export-dialog');
                dialog.innerHTML = `
                    <div class="export-dialog-content">
                        <h2>Seleccionar Códigos para Exportar</h2>
                        <form id="export-form">
                            <div class="codes-selection">
                                ${this.codes.map(code => `
                                    <label>
                                        <input type="checkbox" name="export-codes" value="${code}">
                                        ${code}
                                    </label>
                                `).join('')}
                            </div>
                            <div class="dialog-actions">
                                <button type="button" class="btn btn-cancel">Cancelar</button>
                                <button type="submit" class="btn btn-export">Exportar</button>
                            </div>
                        </form>
                    </div>
                `;

                this.app.appendChild(dialog);

                const exportForm = dialog.querySelector('#export-form');
                const cancelBtn = dialog.querySelector('.btn-cancel');

                cancelBtn.addEventListener('click', () => {
                    this.app.removeChild(dialog);
                });

                exportForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const selectedCodes = Array.from(
                        dialog.querySelectorAll('input[name="export-codes"]:checked')
                    ).map(input => input.value);

                    this.app.removeChild(dialog);
                    this.exportToExcel(selectedCodes);
                });
            }

            exportToExcel(selectedCodes = null) {
                try {
                    const workbook = XLSX.utils.book_new();

                    const codesToExport = selectedCodes && selectedCodes.length > 0 
                        ? selectedCodes 
                        : this.codes;

                    let hasExportedData = false;

                    codesToExport.forEach(code => {
                        const tramos = this.tramos[code] || [];
                        
                        const excelData = tramos.map(tramo => ({
                            'Código de Taladro': code || '',
                            'Profundidad Inicio (m)': tramo.profundidadInicio ? 
                                parseFloat(tramo.profundidadInicio).toFixed(5) : '0.00000',
                            'Profundidad Final (m)': tramo.profundidadFinal ? 
                                parseFloat(tramo.profundidadFinal).toFixed(5) : '0.00000',
                            'Tipo de Roca': tramo.tipoRoca,
                            'Tamaño de Grano': tramo.tamanoGrano,
                            'Contacto Superior': tramo.contactoSuperior,
                            'Contacto Inferior': tramo.contactoInferior,
                            'Zr-TiO2': tramo.zrTiO2 ? 
                                parseFloat(tramo.zrTiO2).toFixed(5) : 'N/A',
                            'AI': tramo.ai ? 
                                parseFloat(tramo.ai).toFixed(5) : 'N/A',
                            'CPPI': tramo.cppi ? 
                                parseFloat(tramo.cppi).toFixed(5) : 'N/A',
                            'Moteado': tramo.moteado,
                            'Magnetismo': tramo.magnetismo,
                            'Tipo de Alteración': tramo.tipoAlteracion || 'N/A',
                            'Porcentaje de Pirita': tramo.porcentajePirita ? 
                                parseFloat(tramo.porcentajePirita).toFixed(5) : 'N/A',
                            'Forma de Mineralización': tramo.formaMin,
                            'Mineralización': tramo.mineralizacion || 'N/A',
                            'Descripción': tramo.descripcion || 'N/A',
                            'Imagen': tramo.image ? 'Sí' : 'No'
                        }));

                        if (excelData.length > 0) {
                            const worksheet = XLSX.utils.json_to_sheet(excelData);
                            XLSX.utils.book_append_sheet(workbook, worksheet, code || 'Sin Nombre');
                            hasExportedData = true;
                        }
                    });

                    if (!hasExportedData) {
                        alert('No hay datos para exportar');
                        return;
                    }

                    const excelBuffer = XLSX.write(workbook, { type: 'array', bookType: 'xlsx' });

                    if (window.cordova) {
                        window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
                        
                        window.requestFileSystem(window.TEMPORARY, excelBuffer.byteLength, (fs) => {
                            fs.root.getFile('Taladros_Exportados.xlsx', { create: true }, (fileEntry) => {
                                fileEntry.createWriter((fileWriter) => {
                                    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                                    
                                    fileWriter.onwriteend = () => {
                                        if (window.cordova.plugins.fileOpener2) {
                                            window.cordova.plugins.fileOpener2.open(
                                                fileEntry.toURL(),
                                                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                                {
                                                    error: () => {
                                                        alert('No se pudo abrir el archivo');
                                                    },
                                                    success: () => {
                                                        alert('Archivo exportado y abierto');
                                                    }
                                                }
                                            );
                                        } else {
                                            alert('Archivo exportado en: ' + fileEntry.toURL());
                                        }
                                    };
                                    
                                    fileWriter.write(blob);
                                });
                            });
                        });
                    } else {
                        XLSX.writeFile(workbook, 'Taladros_Exportados.xlsx');
                    }
                } catch (error) {
                    console.error('Error en exportación:', error);
                    alert('Hubo un error al exportar los datos. Por favor, inténtelo de nuevo.');
                }
            }

            requestPermissions() {
                return new Promise((resolve, reject) => {
                    if (window.cordova && window.cordova.plugins && window.cordova.plugins.permissions) {
                        const permissions = window.cordova.plugins.permissions;
                        
                        const permissionList = [
                            permissions.WRITE_EXTERNAL_STORAGE,
                            permissions.READ_EXTERNAL_STORAGE,
                            permissions.ACCESS_WIFI_STATE,
                            permissions.CHANGE_WIFI_STATE
                        ];

                        const requestMultiplePermissions = (permissions) => {
                            if (permissions.length === 0) {
                                resolve();
                                return;
                            }

                            const currentPermission = permissions.pop();
                            
                            permissions.hasPermission(currentPermission, (status) => {
                                if (!status.hasPermission) {
                                    permissions.requestPermission(currentPermission, 
                                        () => {
                                            requestMultiplePermissions(permissions);
                                        },
                                        () => {
                                            console.warn('Permission denied:', currentPermission);
                                            requestMultiplePermissions(permissions);
                                        }
                                    );
                                } else {
                                    requestMultiplePermissions(permissions);
                                }
                            });
                        };

                        requestMultiplePermissions(permissionList);
                    } else {
                        console.log('Not in mobile environment, skipping permissions');
                        resolve();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.cordova) {
                document.addEventListener('deviceready', () => {
                    new TaladroApp();
                }, false);
            } else {
                new TaladroApp();
            }
        });
    </script>
</body>
</html>